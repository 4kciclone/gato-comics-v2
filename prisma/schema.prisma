generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// --------------------------------------------------------
// ENUMS
// --------------------------------------------------------
enum UserRole {
  USER
  ADMIN
  OWNER
}
enum UnlockType {
  RENTAL
  PERMANENT
}
enum TransactionType {
  DEPOSIT
  SPEND
  EARN
  BONUS
}
enum CurrencyType {
  PREMIUM
  LITE
}
enum LibraryStatus {
  READING
  COMPLETED
  ON_HOLD
  DROPPED
  PLAN_TO_READ
}
enum CosmeticType {
  AVATAR_FRAME
  COMMENT_BACKGROUND
  USERNAME_COLOR
  PROFILE_BANNER
}
enum CosmeticRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}
enum ReportStatus {
  PENDING
  RESOLVED
}
enum SubscriptionTier { 
  BRONZE 
  SILVER 
  GOLD 
  DIAMOND 
}
enum ActivityType {
  NEW_USER
  NEW_SUBSCRIPTION
  NEW_CHAPTER
  NEW_REPORT
  POPULAR_POST
}

// --------------------------------------------------------
// MODELOS DE USUÁRIO & ECONOMIA
// --------------------------------------------------------
model User {
  id                        String        @id @default(cuid())
  username                  String        @unique
  name                      String?
  email                     String        @unique
  emailVerified             DateTime?
  image                     String?
  password                  String?
  role                      UserRole      @default(USER)
  
  // --- CAMPOS NOVOS DA LGPD (2026) ---
  dateOfBirth               DateTime      // Obrigatório para cálculo de idade
  termsAcceptedAt           DateTime      @default(now()) // Prova legal de consentimento
  privacyVersion            String        @default("v1.0") // Controle de versão dos termos
  // ------------------------------------

  balancePremium            Int           @default(0)
  liteCoinBatches           LiteCoinBatch[]
  xp                        Int           @default(0)
  mutedUntil                DateTime?
  equippedAvatarFrameId     String?
  equippedCommentBackgroundId String?
  equippedProfileBannerId   String?
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt

  equippedAvatarFrame       Cosmetic?     @relation("EquippedAvatarFrame", fields: [equippedAvatarFrameId], references: [id], onDelete: SetNull)
  equippedCommentBackground Cosmetic?     @relation("EquippedCommentBg", fields: [equippedCommentBackgroundId], references: [id], onDelete: SetNull)
  equippedProfileBanner     Cosmetic?     @relation("EquippedProfileBanner", fields: [equippedProfileBannerId], references: [id], onDelete: SetNull)
  
  transactions              Transaction[]
  unlocks                   Unlock[]
  reviews                   Review[]
  library                   LibraryEntry[]
  cosmetics                 UserCosmetic[]
  comments                  Comment[]
  posts                     Post[]
  likes                     Like[]
  following                 Follow[]      @relation("Following")
  followers                 Follow[]      @relation("Followers")
  reportsMade               Report[]      @relation("Reporter")
  notifications             Notification[] @relation("Notifications")
  originNotifications       Notification[] @relation("OriginNotifications")
  workLikes                 WorkLike[]
  workEntitlements          WorkEntitlement[]

  // CAMPOS DE ASSINATURA
  stripeCustomerId          String?     @unique
  subscriptionTier          SubscriptionTier?
  subscriptionId            String?     @unique
  subscriptionValidUntil    DateTime?
  entitlementChangeUntil    DateTime?

  @@map("users")
}

// ... MANTENHA O RESTO DO ARQUIVO IGUAL (Transaction, Work, etc...)
// Vou omitir o restante aqui para economizar espaço, pois só o User mudou.
// Certifique-se de manter os outros models (Transaction, Work, etc) abaixo.
model Transaction {
  id          String          @id @default(cuid())
  userId      String
  amount      Int
  currency    CurrencyType
  type        TransactionType
  description String?
  metadata    Json?
  createdAt   DateTime        @default(now())
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@map("transactions")
}
// ... (Continue com o resto do seu arquivo original)
model WorkEntitlement {
  id        String   @id @default(cuid())
  userId    String
  workId    String
  grantedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([userId, workId])
  @@map("work_entitlements")
}
model Work {
  id             String         @id @default(cuid())
  title          String
  slug           String         @unique
  synopsis       String         @db.Text
  coverUrl       String
  bannerUrl      String?
  author         String
  artist         String?
  studio         String?
  genres         String[]
  isAdult        Boolean        @default(false)
  isHidden       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  chapters       Chapter[]
  reviews        Review[]
  entitlements   WorkEntitlement[]
  libraryEntries LibraryEntry[]
  comments       Comment[]
  likes          WorkLike[]
  @@map("works")
}
model Chapter {
  id           String    @id @default(cuid())
  workId       String
  title        String
  slug         String
  order        Float
  pricePremium Int       @default(3)
  priceLite    Int       @default(10)
  isFree       Boolean   @default(false)
  images       String[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  work         Work      @relation(fields: [workId], references: [id], onDelete: Cascade)
  unlocks      Unlock[]
  comments     Comment[]
  @@unique([workId, slug])
  @@unique([workId, order])
  @@index([workId])
  @@map("chapters")
}
model Unlock {
  id        String     @id @default(cuid())
  userId    String
  chapterId String
  type      UnlockType
  expiresAt DateTime?
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapter   Chapter    @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  @@unique([userId, chapterId])
  @@map("unlocks")
}
model Review {
  id        String   @id @default(cuid())
  userId    String
  workId    String
  rating    Int      @default(5)
  text      String?  @db.Text
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  work      Work     @relation(fields: [workId], references: [id], onDelete: Cascade)
  @@unique([userId, workId])
  @@map("reviews")
}
model LibraryEntry {
  id                String        @id @default(cuid())
  userId            String
  workId            String
  status            LibraryStatus @default(READING)
  lastReadChapterId String?
  updatedAt         DateTime      @updatedAt
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  work              Work          @relation(fields: [workId], references: [id], onDelete: Cascade)
  @@unique([userId, workId])
  @@map("library_entries")
}
model Comment {
  id        String    @id @default(cuid())
  content   String    @db.Text
  isSpoiler Boolean   @default(false)
  createdAt DateTime  @default(now())
  userId    String
  workId    String?
  chapterId String?
  postId    String?
  parentId  String?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  work      Work?     @relation(fields: [workId], references: [id], onDelete: Cascade)
  chapter   Chapter?  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  post      Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("Replies", fields: [parentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  replies   Comment[] @relation("Replies")
  reports   Report[]
  @@index([workId])
  @@index([chapterId])
  @@index([postId])
  @@index([parentId])
  @@map("comments")
}
model Cosmetic {
  id                     String         @id @default(cuid())
  name                   String
  description            String
  type                   CosmeticType
  rarity                 CosmeticRarity
  price                  Int
  imageUrl               String
  isActive               Boolean        @default(true)
  owners                 UserCosmetic[]
  equippedAvatarFrames   User[]         @relation("EquippedAvatarFrame")
  equippedCommentBgs     User[]         @relation("EquippedCommentBg")
  equippedProfileBanners User[]         @relation("EquippedProfileBanner")
  @@map("cosmetics")
}
model UserCosmetic {
  userId     String
  cosmeticId String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cosmetic   Cosmetic @relation(fields: [cosmeticId], references: [id], onDelete: Cascade)
  @@id([userId, cosmeticId])
  @@map("user_cosmetics")
}
model Setting {
  key   String @id
  value String
  @@map("settings")
}
model Post {
  id        String    @id @default(cuid())
  content   String    @db.Text
  imageUrl  String?
  createdAt DateTime  @default(now())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes     Like[]
  parentId  String?
  parent    Post?     @relation("Replies", fields: [parentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  replies   Post[]    @relation("Replies")
  comments  Comment[]
  reports Report[]
  @@index([userId])
  @@index([parentId])
  @@map("posts")
}
model Like {
  userId    String
  postId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  @@id([userId, postId])
  @@map("likes")
}
model Follow {
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)
  @@id([followerId, followingId])
  @@map("follows")
}
model Report {
  id         String       @id @default(cuid())
  reason     String
  notes      String?      @db.Text
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  resolvedAt DateTime?
  commentId  String?
  comment    Comment?     @relation(fields: [commentId], references: [id], onDelete: Cascade)
  postId     String? 
  post       Post?       @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporterId String
  reporter   User         @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  @@index([commentId])
  @@index([postId]) 
  @@index([reporterId])
  @@map("reports")
}
model Notification {
  id           String   @id @default(cuid())
  userId       String
  originUserId String
  type         String
  link         String
  isRead       Boolean  @default(false)
  createdAt    DateTime @default(now())
  user         User     @relation("Notifications", fields: [userId], references: [id], onDelete: Cascade)
  originUser   User     @relation("OriginNotifications", fields: [originUserId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@map("notifications")
}
model WorkLike {
  userId    String
  workId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  work      Work     @relation(fields: [workId], references: [id], onDelete: Cascade)
  @@id([userId, workId])
  @@map("work_likes")
}
model LiteCoinBatch {
  id        String   @id @default(cuid())
  userId    String
  amount    Int      
  createdAt DateTime @default(now())
  expiresAt DateTime 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, expiresAt])
  @@map("lite_coin_batches")
}
model ActivityLog {
  id        String       @id @default(cuid())
  type      ActivityType
  message   String       
  link      String?      
  metadata  Json?        
  createdAt DateTime     @default(now())
  @@index([createdAt])
  @@map("activity_logs")
}